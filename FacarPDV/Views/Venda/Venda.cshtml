@using Domain.Domain
@{
    ViewData["Title"] = "Ponto de Venda";
    var clienteSel = ViewBag.Cliente as Cliente;
    var produtoSel = ViewBag.Produto as Produto;

    // Carrinho vindo do controller (TempData JSON -> ViewBag)
    var itens = ViewBag.Itens as List<FacarPDV.Controllers.VendaController.ItemCarrinho> ?? new();
    decimal total = ViewBag.Total ?? 0M;
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 rounded-3">
                <div class="card-header bg-warning text-center">
                    <h4 class="mb-0 fw-bold text-dark">@ViewData["Title"]</h4>
                </div>

                <div class="card-body p-4">

                    <!-- === BUSCA (GET) de Cliente e Produto === -->
                    <form asp-action="Venda" method="get" autocomplete="off" class="mb-4">
                        <div class="row mb-4">
                            <div class="col-md-2">
                                <label for="codigoCliente" class="form-label">Cód. Cliente</label>
                                <input type="number" id="codigoCliente" name="codigoCliente"
                                       value="@(clienteSel?.Id)"
                                       class="form-control" placeholder="Código Cliente" />
                            </div>

                            <div class="col-md-10">
                                <label for="cliente" class="form-label">Cliente</label>
                                <div class="input-group">
                                    <input type="text" id="cliente" name="cliente"
                                           value="@(clienteSel?.Nome ?? "")"
                                           class="form-control" placeholder="Nome do cliente" />
                                    <button type="submit" class="btn btn-outline-warning">
                                        <i class="bi bi-search"></i> Buscar
                                    </button>
                                </div>
                                <small class="text-muted">Digite para ver sugestões e escolha o cliente correto.</small>
                            </div>
                        </div>

                        <div class="row mb-3 align-items-end">
                            <div class="col-md-2">
                                <label for="codigoProduto" class="form-label">Cód. Produto</label>
                                <input type="number" id="codigoProduto" name="codigoProduto"
                                       value="@(produtoSel?.ProdutoId)"
                                       class="form-control" placeholder="Código Produto" />
                            </div>

                            <div class="col-md-8">
                                <label for="produto" class="form-label">Produto</label>
                                <div class="input-group">
                                    <input type="text" id="produto" name="produto"
                                           value="@(produtoSel?.Nome ?? "")"
                                           class="form-control" placeholder="Nome do produto" />
                                    <button type="submit" class="btn btn-outline-warning">
                                        <i class="bi bi-search"></i> Buscar
                                    </button>
                                </div>
                                <small class="text-muted">Digite para ver sugestões e escolha o produto correto.</small>
                            </div>

                            <div class="col-md-2 d-flex align-items-end">
                                <a asp-action="Venda" class="btn btn-outline-dark w-100">
                                    Limpar
                                </a>
                            </div>
                        </div>
                    </form>
                    <!-- === /BUSCA === -->
                    <!-- === ADICIONAR ITEM (POST) === -->
                    <form asp-action="RegistrarVenda" method="post" autocomplete="off" class="mb-3">
                        @Html.AntiForgeryToken()
                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <div class="form-text">
                                    Cliente selecionado: <strong>@(clienteSel?.Nome ?? "nenhum")</strong>
                                </div>
                                <input type="hidden" name="codigoCliente" value="@(clienteSel?.Id)" />
                            </div>
                            <div class="col-md-4">
                                <div class="form-text">
                                    Produto selecionado: <strong>@(produtoSel?.Nome ?? "nenhum")</strong>
                                    @if (produtoSel != null)
                                    {
                                        <span class="ms-2">(Preço: @produtoSel.Preco.ToString("C"))</span>
                                    }
                                </div>
                                <input type="hidden" name="codigoProduto" value="@(produtoSel?.ProdutoId)" />
                            </div>

                            <div class="col-md-2">
                                <label for="quantidade" class="form-label">Quantidade</label>
                                <input type="number" id="quantidade" name="quantidade"
                                       class="form-control" value="1" min="1" required />
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-2 ms-auto">
                                <button type="submit" class="btn btn-primary w-100"
                                        @(clienteSel == null || produtoSel == null ? "disabled" : "")>
                                    <i class="bi bi-cart-plus"></i> Adicionar
                                </button>
                            </div>
                        </div>
                    </form>
                    <!-- === /ADICIONAR ITEM === -->
                    <!-- === LISTA DO CARRINHO === -->
                    <div class="table-responsive mt-4">
                        <table class="table table-striped align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Código</th>
                                    <th>Produto</th>
                                    <th class="text-center">Qtde</th>
                                    <th class="text-end">Preço Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (itens.Count == 0)
                                {
                                    <tr><td colspan="6" class="text-center text-muted">Nenhum item adicionado</td></tr>
                                }
                                else
                                {
                                    foreach (var i in itens)
                                    {
                                        <tr>
                                            <td>@i.ProdutoId</td>
                                            <td>@i.Nome</td>
                                            <td class="text-center">@i.Quantidade</td>
                                            <td class="text-end">@i.Preco.ToString("C")</td>
                                            <td class="text-end">@i.Subtotal.ToString("C")</td>
                                            <td class="text-center">
                                                <form asp-action="RemoverItem" method="post" class="d-inline"
                                                      onsubmit="return confirm('Remover este item?');">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="produtoId" value="@i.ProdutoId" />
                                                    <input type="hidden" name="codigoCliente" value="@(clienteSel?.Id)" />
                                                    <button class="btn btn-sm btn-outline-danger">
                                                        <i class="bi bi-x-circle"></i> Remover
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <h5>Total: <span class="fw-bold">@total.ToString("C")</span></h5>

                        <form asp-action="FinalizarVenda" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="codigoCliente" value="@(clienteSel?.Id ?? 0)" />
                            <button class="btn btn-success px-4"
                                    @(itens.Count == 0 || clienteSel == null ? "disabled" : "")>
                                <i class="bi bi-cash-coin"></i> Finalizar Venda
                            </button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        async function autoComplete(inputId, apiUrl, onPick) {
            const input = document.getElementById(inputId);
            const wrapId = inputId + "_acwrap";
            let wrap = document.getElementById(wrapId);
            if (!wrap) {
                wrap = document.createElement('div');
                wrap.id = wrapId;
                wrap.style.position = 'relative';
                input.parentElement.parentElement.appendChild(wrap);
            }
            // limpa e cria lista
            wrap.innerHTML = '';
            const list = document.createElement('div');
            list.className = 'list-group position-absolute w-100';
            list.style.zIndex = 1000;
            wrap.appendChild(list);

            const term = input.value.trim();
            if (!term) { list.remove(); return; }

            const res = await fetch(apiUrl + encodeURIComponent(term));
            const data = await res.json();
            if (!Array.isArray(data)) return;

            data.forEach(item => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'list-group-item list-group-item-action';
                btn.textContent = item.label + (item.preco !== undefined ? ` — R$ ${item.preco}` : '');
                btn.onclick = () => { onPick(item); list.remove(); };
                list.appendChild(btn);
            });
        }

        // cliente
        const inputCliente = document.getElementById('cliente');
        if (inputCliente) {
            inputCliente.addEventListener('input', () => {
                autoComplete('cliente', '@Url.Action("AutoCompleteClientes", "Venda")?q=', c => {
                    inputCliente.value = c.label;
                    const url = new URL(window.location.href);
                    url.searchParams.set('codigoCliente', c.id);
                    url.searchParams.delete('cliente');
                    window.location.href = url.toString();
                });
            });
        }

        // produto
        const inputProduto = document.getElementById('produto');
        if (inputProduto) {
            inputProduto.addEventListener('input', () => {
                autoComplete('produto', '@Url.Action("AutoCompleteProdutos", "Venda")?q=', p => {
                    inputProduto.value = p.label;
                    const url = new URL(window.location.href);
                    url.searchParams.set('codigoProduto', p.id);
                    url.searchParams.delete('produto');
                    window.location.href = url.toString();
                });
            });
        }
    </script>
}
